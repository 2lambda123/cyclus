<!DOCTYPE html>
<html>
<head>
  <title>WebSocket demo</title>
</head>
<body>
  <script src="ws_events_dispatcher.js"></script>
  <script>
    /* New connection to server and other global varaibles */
    var ws = new EventsDispatcher("ws://127.0.0.1:4242/");

    /* Some helper functions */
    var replaceList = function(elem, vals) {
      while (elem.hasChildNodes()) {
        elem.removeChild(elem.firstChild);
      }
      for (var i = 0; i < vals.length; i++) {
        var li_elem = document.createElement('li');
        var content = document.createTextNode(vals[i]);
        li_elem.appendChild(content);
        elem.appendChild(li_elem);
      }
    };


    /*
    ws.bind('tabledata', function (event) {
      var messages = document.getElementsByTagName('ul')[0],
        message = document.createElement('li'),
        content = document.createTextNode(event.data.columns);
      message.appendChild(content);
      messages.appendChild(message);
      });
    */

    /* Heartbeat handling code */

    var heartbeatNoPulse = function () {
      var hb = document.getElementById('heartbeat');
      hb.innerHTML = "Disconected ";
    };

    var heartbeatTimeout = setTimeout(heartbeatNoPulse, 1);

    ws.bind('heartbeat', function (event) {
        clearTimeout(heartbeatTimeout);
        var hb = document.getElementById('heartbeat');
        hb.innerHTML = "Conected ";
        heartbeatTimeout = setTimeout(heartbeatNoPulse, 1500*event.data);
    });

    /* bind event names to functions when recieved */

    ws.bind('table_names', function (event) {
      var elem = document.getElementById('tableNamesList');
      replaceList(elem, event.data);
    });

    ws.bind('registry', function (event) {
      var reg = document.getElementById('registryList');
      replaceList(reg, event.data);
    });

    ws.bind('echo', function(event) {
      alert(event.data);
    });

    /* Functions to call on button clicks. */

    var loadTableNames = function() {
      var event = {"event": "table_names_request"};
      ws.send(event);
    };

    var loadRegistry = function() {
      var event = {"event": "registry_request"};
      ws.send(event);
    };

    var echoBravo = function() {
      var event = {"event": "echo", "params": {"s": "Bravo"}};
      ws.send(event);
    };
  </script>

  <h2>Heartbeat</h2>
  <p id="heartbeat">Disconected</p>

  <h2>Table Names</h2>
  <button onclick="loadTableNames()">Load Table Names</button>
  <ul id="tableNamesList"></ul>

  <h2>Registry</h2>
  <button onclick="loadRegistry()">Load Registry</button>
  <ul id="registryList"></ul>

  <h2>Echo Test</h2>
  <button onclick="echoBravo()">Echo</button>
</body>
</html>